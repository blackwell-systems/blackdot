#!/usr/bin/env zsh
# ============================================================
# FILE: bin/dotfiles-template
# Template management CLI for machine-specific configurations
#
# Usage:
#   dotfiles template init          # Interactive setup
#   dotfiles template render        # Render all templates
#   dotfiles template render FILE   # Render specific template
#   dotfiles template check         # Validate template syntax
#   dotfiles template diff          # Show what would change
#   dotfiles template vars          # List all variables
#   dotfiles template edit          # Edit local variables
#   dotfiles template link          # Symlink generated files
#
# Environment Variables:
#   DEBUG=1                         # Enable debug output
#   DOTFILES_TMPL_*                 # Override any template variable
#   DOTFILES_MACHINE_TYPE           # Force machine type (work/personal)
#
# Examples:
#   dotfiles template init
#   dotfiles template render --dry-run
#   dotfiles template vars --quiet
#   DOTFILES_TMPL_GIT_EMAIL="me@example.com" dotfiles template render
# ============================================================

set -euo pipefail

# ============================================================
# Setup
# ============================================================
SCRIPT_DIR="${0:A:h}"
DOTFILES_DIR="${SCRIPT_DIR:h}"

# Source libraries
source "$DOTFILES_DIR/lib/_logging.sh"
source "$DOTFILES_DIR/lib/_templates.sh"

# ============================================================
# Usage
# ============================================================
usage() {
    print "${BOLD}dotfiles template${NC} - Machine-specific configuration management"
    print ""
    print "${CYAN}USAGE${NC}"
    print "    dotfiles template <command> [options]"
    print ""
    print "${CYAN}COMMANDS${NC}"
    print "    init              Interactive setup - creates _variables.local.sh"
    print "    render            Render all templates to generated/"
    print "    render <file>     Render a specific template file"
    print "    check             Validate template syntax"
    print "    diff              Show differences between templates and generated files"
    print "    vars              List all template variables and values"
    print "    filters           List available pipeline filters"
    print "    edit              Open _variables.local.sh in editor"
    print "    link              Create symlinks from generated files to destinations"
    print "    list              Show available templates and their status"
    print "    arrays            Manage JSON/shell arrays for {{#each}} loops"
    print "    help              Show this help message"
    print ""
    print "${CYAN}OPTIONS${NC}"
    print "    --dry-run, -n     Show what would be done without doing it"
    print "    --force, -f       Force re-render even if up to date"
    print "    --verbose, -v     Show detailed output"
    print "    --quiet, -q       Minimal output"
    print ""
    print "${CYAN}ARRAYS OPTIONS${NC}"
    print "    --export-json, -e Export shell arrays to JSON format"
    print "    --validate, -v    Validate JSON arrays file syntax"
    print ""
    print "${CYAN}EXAMPLES${NC}"
    print "    # First-time setup"
    print "    dotfiles template init"
    print ""
    print "    # See current variable values"
    print "    dotfiles template vars"
    print ""
    print "    # Preview what would be generated"
    print "    dotfiles template render --dry-run"
    print ""
    print "    # Render and link all templates"
    print "    dotfiles template render && dotfiles template link"
    print ""
    print "    # Override a variable for one render"
    print "    DOTFILES_TMPL_GIT_EMAIL=\"other@example.com\" dotfiles template render"
    print ""
    print "    # View loaded arrays (from JSON or shell)"
    print "    dotfiles template arrays"
    print ""
    print "    # Export shell arrays to JSON format"
    print "    dotfiles template arrays --export-json"
    print ""
    print "    # Validate JSON arrays file"
    print "    dotfiles template arrays --validate"
    print ""
    print "${CYAN}TEMPLATE SYNTAX${NC}"
    print "    {{ variable }}              Variable substitution"
    print "    {{ var | filter }}          Pipeline filter"
    print "    {{ var | filter \"arg\" }}    Filter with argument"
    print "    {{ var | f1 | f2 }}         Chained filters"
    print "    {{#if variable }}...{{/if}} Conditional block"
    print "    {{#if var == \"value\" }}     Conditional with comparison"
    print "    {{#unless variable }}       Negative conditional"
    print "    {{#each array }}...{{/each}} Loop over array items"
    print ""
    print "${CYAN}FILES${NC}"
    print "    templates/_variables.sh         Default variable definitions"
    print "    templates/_variables.local.sh   Machine-specific overrides (gitignored)"
    print "    templates/_arrays.local.json    JSON arrays for {{#each}} loops (gitignored)"
    print "    templates/configs/*.tmpl        Template files"
    print "    generated/*                     Rendered output (gitignored)"
    print ""
    print "${CYAN}DOCUMENTATION${NC}"
    print "    Full guide: docs/templates.md"
    print "    Online:     https://blackwell-systems.github.io/dotfiles/#/templates"
    print ""
}

# ============================================================
# Interactive Prompt Helpers
# ============================================================

# Prompt for a value with default
# Usage: prompt_value "Git name" "$default" variable_name [required]
prompt_value() {
    local label="$1"
    local default="$2"
    local varname="$3"
    local required="${4:-false}"
    local value

    if [[ -n "$default" ]]; then
        printf "  ${CYAN}%s${NC} [%s]: " "$label" "$default"
    else
        printf "  ${CYAN}%s${NC}: " "$label"
    fi

    read -r value
    value="${value:-$default}"

    if [[ "$required" == "true" && -z "$value" ]]; then
        warn "  This field is required"
        prompt_value "$label" "$default" "$varname" "$required"
        return
    fi

    eval "$varname=\"\$value\""
}

# Prompt for choice from list
# Usage: prompt_choice "Machine type" "work personal unknown" machine_type [default]
prompt_choice() {
    local label="$1"
    local choices="$2"
    local varname="$3"
    local default="${4:-}"

    print "  ${CYAN}${label}:${NC}"
    local i=1
    local choice_array=("${(@s/ /)choices}")
    for choice in $choice_array; do
        if [[ "$choice" == "$default" ]]; then
            print "    ${GREEN}$i)${NC} $choice ${DIM}(detected)${NC}"
        else
            print "    $i) $choice"
        fi
        (( i++ ))
    done

    printf "  Enter choice [1-%d]: " "${#choice_array[@]}"
    local selection
    read -r selection

    if [[ -z "$selection" && -n "$default" ]]; then
        eval "$varname=\"\$default\""
    elif [[ "$selection" =~ ^[0-9]+$ ]] && (( selection >= 1 && selection <= ${#choice_array[@]} )); then
        eval "$varname=\"\${choice_array[$selection]}\""
    else
        eval "$varname=\"\${choice_array[1]}\""
    fi
}

# ============================================================
# Commands
# ============================================================

# Interactive initialization
cmd_init() {
    local local_file="$TEMPLATES_DIR/_variables.local.sh"
    local example_file="$TEMPLATES_DIR/_variables.local.sh.example"

    print "${BOLD}Template System Setup${NC}"
    print "═════════════════════════════════════════════════════════════"
    print ""

    # Build auto vars to show current detection
    build_auto_vars

    print "${CYAN}Detected System:${NC}"
    printf "  %-20s %s\n" "Hostname:" "${TMPL_AUTO[hostname]}"
    printf "  %-20s %s\n" "OS:" "${TMPL_AUTO[os]} (${TMPL_AUTO[os_family]})"
    printf "  %-20s %s\n" "Architecture:" "${TMPL_AUTO[arch]}"
    printf "  %-20s %s\n" "User:" "${TMPL_AUTO[user]}"
    printf "  %-20s %s\n" "Machine Type:" "${TMPL_AUTO[machine_type]}"
    print ""

    # Check if local file exists
    if [[ -f "$local_file" ]]; then
        warn "Local variables file already exists: $local_file"
        print ""
        read -q "?Reconfigure? [y/N] " || { print ""; return 0; }
        print ""
    fi

    # ================================================================
    # Interactive Prompts for Essential Variables
    # ================================================================
    print "${BOLD}Essential Configuration${NC}"
    print "───────────────────────────────────────"
    print ""

    # Detect defaults from git config
    local default_name default_email default_github
    default_name=$(git config --global user.name 2>/dev/null || echo "")
    default_email=$(git config --global user.email 2>/dev/null || echo "")
    default_github=$(git config --global github.user 2>/dev/null || echo "")

    # Prompt for required values
    local git_name git_email machine_type github_user

    prompt_value "Git name (required)" "$default_name" git_name true
    prompt_value "Git email (required)" "$default_email" git_email true
    print ""

    prompt_choice "Machine type" "work personal unknown" machine_type "${TMPL_AUTO[machine_type]}"
    print ""

    prompt_value "GitHub username (optional)" "$default_github" github_user false
    print ""

    # ================================================================
    # Generate the local variables file
    # ================================================================
    print "${BOLD}Writing Configuration${NC}"
    print "───────────────────────────────────────"

    # Create the file with user's values
    cat > "$local_file" << LOCALVARS
#!/usr/bin/env zsh
# ============================================================
# FILE: templates/_variables.local.sh
# Machine-specific template variable overrides
#
# Generated by: dotfiles template init
# Generated on: $(date '+%Y-%m-%d %H:%M:%S')
#
# Edit this file to customize your configuration.
# Run 'dotfiles template render' after making changes.
# ============================================================

# ============================================================
# Git Configuration (required)
# ============================================================
TMPL_DEFAULTS[git_name]="$git_name"
TMPL_DEFAULTS[git_email]="$git_email"

# Optional: GPG signing key
# TMPL_DEFAULTS[git_signing_key]="ABCD1234EFGH5678"

# ============================================================
# Machine Type
# Values: work, personal, unknown
# ============================================================
TMPL_AUTO[machine_type]="$machine_type"

# ============================================================
# GitHub Configuration
# ============================================================
TMPL_DEFAULTS[github_user]="$github_user"

# ============================================================
# Work Machine Overrides
# Only applied when machine_type == "work"
# ============================================================
# TMPL_WORK[git_email]="your.name@company.com"
# TMPL_WORK[aws_profile]="work"
# TMPL_WORK[github_enterprise_host]="github.company.com"

# ============================================================
# Personal Machine Overrides
# Only applied when machine_type == "personal"
# ============================================================
# TMPL_PERSONAL[git_email]="personal@example.com"

# ============================================================
# SSH Hosts
# Format: name|hostname|user|identity_file|extra_options
# ============================================================
SSH_HOSTS=(
    "github|github.com|git|~/.ssh/id_ed25519|"
    # "work-bastion|bastion.company.com|admin|~/.ssh/id_ed25519_work|"
)

# ============================================================
# Advanced Configuration
# Uncomment and customize as needed
# ============================================================
# TMPL_DEFAULTS[aws_profile]="default"
# TMPL_DEFAULTS[bedrock_profile]="bedrock"
# TMPL_DEFAULTS[editor]="nvim"
# TMPL_DEFAULTS[projects_dir]="\$HOME/code"
# TMPL_DEFAULTS[enable_nvm]="true"
# TMPL_DEFAULTS[enable_k8s_prompt]="true"
LOCALVARS

    pass "Created: $local_file"
    print ""

    # ================================================================
    # Summary
    # ================================================================
    print "${BOLD}Configuration Summary${NC}"
    print "───────────────────────────────────────"
    printf "  %-20s ${GREEN}%s${NC}\n" "Git name:" "$git_name"
    printf "  %-20s ${GREEN}%s${NC}\n" "Git email:" "$git_email"
    printf "  %-20s ${GREEN}%s${NC}\n" "Machine type:" "$machine_type"
    [[ -n "$github_user" ]] && printf "  %-20s ${GREEN}%s${NC}\n" "GitHub user:" "$github_user"
    print ""

    print "${CYAN}Next steps:${NC}"
    print "  1. ${BOLD}dotfiles template vars${NC}    - Review all variables"
    print "  2. ${BOLD}dotfiles template render${NC} - Generate config files"
    print "  3. ${BOLD}dotfiles template link${NC}   - Symlink to destinations"
    print ""

    # Ask if user wants to edit for advanced config
    if confirm "Open editor for advanced configuration?"; then
        ${EDITOR:-vim} "$local_file"
    fi
}

# Render templates
cmd_render() {
    local dry_run=false
    local force=false
    local specific_file=""

    # Parse arguments
    while [[ $# -gt 0 ]]; do
        case "$1" in
            --dry-run|-n) dry_run=true ;;
            --force|-f) force=true ;;
            --verbose|-v) DEBUG=1 ;;
            -*)
                fail "Unknown option: $1"
                return 1
                ;;
            *)
                specific_file="$1"
                ;;
        esac
        shift
    done

    if [[ -n "$specific_file" ]]; then
        # Render specific template
        local template_path="$specific_file"

        # If just filename, look in configs/
        if [[ ! -f "$template_path" ]]; then
            template_path="$TEMPLATES_CONFIG_DIR/$specific_file"
        fi
        # Add .tmpl if missing
        if [[ ! -f "$template_path" && ! "$template_path" == *.tmpl ]]; then
            template_path="${template_path}.tmpl"
        fi

        if [[ ! -f "$template_path" ]]; then
            fail "Template not found: $specific_file"
            return 1
        fi

        local basename="${template_path:t:r}"
        local output_file="$GENERATED_DIR/$basename"

        render_template "$template_path" "$output_file" "$dry_run"
    else
        # Render all templates
        render_all_templates "$dry_run" "$force"
    fi
}

# Check template syntax
cmd_check() {
    validate_all_templates
}

# Show diff
cmd_diff() {
    local verbose=false
    [[ "${1:-}" == "-v" || "${1:-}" == "--verbose" ]] && verbose=true

    show_template_diff "$verbose"
}

# List variables
cmd_vars() {
    local quiet=false
    [[ "${1:-}" == "-q" || "${1:-}" == "--quiet" ]] && quiet=true

    if [[ "$quiet" == "true" ]]; then
        list_template_vars false
    else
        list_template_vars true
    fi
}

# Edit local variables
cmd_edit() {
    local local_file="$TEMPLATES_DIR/_variables.local.sh"

    if [[ ! -f "$local_file" ]]; then
        warn "Local variables file not found"
        print "Run 'dotfiles template init' first"
        return 1
    fi

    ${EDITOR:-vim} "$local_file"
    pass "Edited: $local_file"
    print ""
    print "${CYAN}Tip:${NC} Run 'dotfiles template render' to apply changes"
}

# Link generated files to destinations
cmd_link() {
    local dry_run=false
    [[ "${1:-}" == "--dry-run" || "${1:-}" == "-n" ]] && dry_run=true

    info "Linking generated files..."

    # Define destinations for generated files
    # Format: generated_filename -> destination_path
    typeset -A LINK_MAP=(
        [gitconfig]="$HOME/.gitconfig"
        [99-local.zsh]="$DOTFILES_DIR/zsh/zsh.d/99-local.zsh"
        [ssh-config]="$HOME/.ssh/config"
        [claude.local]="$HOME/.claude.local"
    )

    local count=0
    local errors=0

    for file dest in "${(@kv)LINK_MAP}"; do
        local src="$GENERATED_DIR/$file"

        if [[ ! -f "$src" ]]; then
            debug "Skipping (not generated): $file"
            continue
        fi

        if [[ "$dry_run" == "true" ]]; then
            dry "Would link: $src → $dest"
        else
            # Create parent directory if needed
            mkdir -p "$(dirname "$dest")"

            # Backup existing file if it's not already a symlink to our file
            if [[ -e "$dest" && ! -L "$dest" ]]; then
                local backup="${dest}.backup.$(date +%Y%m%d%H%M%S)"
                mv "$dest" "$backup"
                info "Backed up: $dest → $backup"
            elif [[ -L "$dest" ]]; then
                # Remove existing symlink
                rm "$dest"
            fi

            # Create symlink
            if ln -s "$src" "$dest"; then
                pass "Linked: $file → $dest"
                (( count++ ))
            else
                fail "Failed to link: $file"
                (( errors++ ))
            fi
        fi
    done

    if [[ $count -eq 0 && "$dry_run" != "true" ]]; then
        info "No files to link (run 'dotfiles template render' first)"
    else
        info "Linked $count file(s)"
    fi

    [[ $errors -eq 0 ]]
}

# List available templates
cmd_list() {
    print "${BOLD}Available Templates${NC}"
    print "───────────────────────────────────────"

    for template in "$TEMPLATES_CONFIG_DIR"/*.tmpl(N); do
        local basename="${template:t:r}"
        local output="$GENERATED_DIR/$basename"
        local file_status=""  # Initialize to avoid zsh printing previous value

        if [[ -f "$output" ]]; then
            if [[ "$output" -nt "$template" ]]; then
                file_status="${GREEN}✓ up to date${NC}"
            else
                file_status="${YELLOW}○ stale${NC}"
            fi
        else
            file_status="${RED}✗ not generated${NC}"
        fi

        printf "  %-25s %b\n" "$basename" "$file_status"
    done
}

# Show available filters
cmd_filters() {
    list_filters
}

# Show/manage arrays
cmd_arrays() {
    local export_json=false
    local validate=false

    while [[ $# -gt 0 ]]; do
        case "$1" in
            --export-json|-e) export_json=true ;;
            --validate|-v) validate=true ;;
            *) ;;
        esac
        shift
    done

    if [[ "$export_json" == "true" ]]; then
        # Export current shell arrays to JSON
        export_arrays_to_json
        return
    fi

    if [[ "$validate" == "true" ]]; then
        local json_file="$TEMPLATES_DIR/_arrays.local.json"
        if [[ ! -f "$json_file" ]]; then
            info "No JSON arrays file found: $json_file"
            return 0
        fi
        if jq -e '.' "$json_file" &>/dev/null; then
            pass "Valid JSON: $json_file"
            # Show structure
            jq -r 'keys[]' "$json_file" | while read -r key; do
                local count=$(jq -r ".$key | length" "$json_file")
                print "  • $key: $count items"
            done
            return 0
        else
            fail "Invalid JSON: $json_file"
            jq '.' "$json_file" 2>&1 | head -5
            return 1
        fi
    fi

    # Default: list arrays
    list_template_arrays
}

# ============================================================
# Main
# ============================================================
main() {
    local command="${1:-help}"
    shift 2>/dev/null || true

    case "$command" in
        init)
            cmd_init "$@"
            ;;
        render)
            cmd_render "$@"
            ;;
        check|validate)
            cmd_check "$@"
            ;;
        diff)
            cmd_diff "$@"
            ;;
        vars|variables)
            cmd_vars "$@"
            ;;
        filters)
            cmd_filters "$@"
            ;;
        edit)
            cmd_edit "$@"
            ;;
        link|symlink)
            cmd_link "$@"
            ;;
        list|ls)
            cmd_list "$@"
            ;;
        arrays)
            cmd_arrays "$@"
            ;;
        help|-h|--help)
            usage
            ;;
        *)
            fail "Unknown command: $command"
            print "Run 'dotfiles template help' for usage"
            return 1
            ;;
    esac
}

main "$@"
